"""
???????? ????? ??????????
"""

import logging
from seditor.terminal.manager import TerminalManager
from seditor.terminal.layout import Layout
from seditor.components.file_tree import FileTreePane
from seditor.components.editor import EditorPane

# ????????? ??????????? ??? ???????
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    filename='seditor_debug.log'
)
logger = logging.getLogger(__name__)


class App:
    """??????? ????? ?????????? seditor"""

    def __init__(self):
        """????????????? ??????????"""
        self.term_manager = TerminalManager()
        width, height = self.term_manager.get_size()
        self.layout = Layout(width, height)
        self.file_tree = FileTreePane(self.layout)
        self.editor = EditorPane(self.layout)
        self.running = False
        
        # ??????? ??????: 'tree' | 'editor' | 'command'
        self.focused_pane = 'tree'  # ?? ????????? ????? ?? ??????
        
        # ???? ? ???????? ????????? ?????
        self.current_file = None
        
        # ???????? ??????? ?????? (???????? ? ???????)
        self.debug_keys = True

    def _draw_separator(self, terminal) -> str:
        """
        ?????????? ???????????? ??????????? ????? ????????

        Args:
            terminal: ?????? blessed.Terminal

        Returns:
            ?????? ? ANSI-?????? ??? ????????? ???????????
        """
        output = []
        separator_x = self.layout.separator_x
        height = self.layout.height

        # ???????????? ????? ???????????
        for y in range(height):
            output.append(terminal.move_xy(separator_x, y) + "?")

        return "".join(output)

    def _render_all(self) -> str:
        """
        ??????????? ???? ????? (??? ?????? + ???????????)

        Returns:
            ?????? ? ANSI-?????? ??? ?????? ?????????
        """
        terminal = self.term_manager.get_terminal()
        output = []

        # ??????? ??????
        output.append(self.term_manager.clear())

        # ????????? ?????? ?????? ?????? (? ???????)
        output.append(self.file_tree.render(terminal, focused=(self.focused_pane == 'tree')))

        # ????????? ???????????
        output.append(self._draw_separator(terminal))

        # ????????? ?????? ????????? (? ???????)
        output.append(self.editor.render(terminal, focused=(self.focused_pane == 'editor')))

        return "".join(output)

    def _render_with_status(self) -> None:
        """??????????? ????? ? ????????? ??????"""
        terminal = self.term_manager.get_terminal()
        output = self._render_all()
        
        # ????????? ??????
        focus_indicator = f"[{self.focused_pane.upper()}]" if self.focused_pane else ""
        status_msg = f"Press 'q' to quit | Tab to switch | {focus_indicator}"
        status_y = self.layout.height - 1
        status_x = 0
        # ???????? ?????? ????? ??????? ???????
        status_line = terminal.move_xy(status_x, status_y) + " " * self.layout.terminal_width
        status_text = terminal.move_xy(status_x, status_y) + status_msg
        
        print(output + status_line + status_text, end="", flush=True)

    def _toggle_focus(self) -> None:
        """??????????? ????? ????? ???????? (Command+Tab ??? Tab)"""
        if self.focused_pane == 'tree':
            self.focused_pane = 'editor'
        elif self.focused_pane == 'editor':
            self.focused_pane = 'tree'
        # command ???? ?? ???????????

    def _log_key(self, inp, context: str = "") -> None:
        """?????????? ?????????? ? ??????? ??????? ??? ???????"""
        if self.debug_keys:
            key_info = {
                'repr': repr(inp),
                'str': str(inp),
                'name': getattr(inp, 'name', 'NO_NAME'),
                'code': getattr(inp, 'code', 'NO_CODE'),
                'is_sequence': getattr(inp, 'is_sequence', 'NO_IS_SEQUENCE'),
            }
            logger.debug(f"Key pressed {context}: {key_info}")
            # ????? ??????? ? ???? ??? ???????
            with open('seditor_keys.log', 'a') as f:
                f.write(f"{context}: {key_info}\n")

    def _handle_tree_key(self, inp) -> None:
        """?????????? ??????? ? ?????? ?????? ??????"""
        # ??????????? ??? ???????
        self._log_key(inp, f"[TREE FOCUS]")
        
        # ? blessed ??? ??????????? ?????? ????? ????????? .name ??? .is_sequence
        key_name = getattr(inp, 'name', None)
        key_code = getattr(inp, 'code', None)
        key_str = str(inp)
        
        logger.debug(f"Processing key: name={key_name}, code={key_code}, str={key_str}")
        
        # ????????? ?????????
        if key_name == 'KEY_UP' or (key_code and 'up' in str(key_code).lower()):
            logger.debug("Moving UP")
            self.file_tree.move_up()
        elif key_name == 'KEY_DOWN' or (key_code and 'down' in str(key_code).lower()):
            logger.debug("Moving DOWN")
            self.file_tree.move_down()
        elif key_str == '\x1b[A':  # ESC[A - ??????? ?????
            logger.debug("Moving UP (ESC sequence)")
            self.file_tree.move_up()
        elif key_str == '\x1b[B':  # ESC[B - ??????? ????
            logger.debug("Moving DOWN (ESC sequence)")
            self.file_tree.move_down()
        
        # Enter - ????? ? ?????????? ??? ??????? ????
        elif key_name == 'KEY_ENTER' or key_str == '\n' or key_str == '\r':
            logger.debug("Enter pressed")
            result = self.file_tree.enter()
            if result:
                # ??????? ???? ? ?????????
                self.current_file = result
                # TODO: ????????? ???? ? ????????
                self.focused_pane = 'editor'  # ??????????? ????? ?? ????????
        
        # ??????? ??? ????????????/??????????????
        elif key_name == 'KEY_LEFT' or key_str == '\x1b[D':  # ESC[D
            logger.debug("Left arrow - collapsing")
            self.file_tree.collapse_directory()
        elif key_name == 'KEY_RIGHT' or key_str == '\x1b[C':  # ESC[C
            logger.debug("Right arrow - expanding")
            self.file_tree.expand_directory()
        
        # Backspace - ????????? ?? ??????? ????
        elif key_name == 'KEY_BACKSPACE' or key_str == '\x7f' or key_str == '\b':
            logger.debug("Backspace - going up level")
            self.file_tree.go_up_level()
        
        # Command+Backspace - ??????? ???? (? ??????????????)
        # TODO: ?????????? ?????????? Command+Backspace ?? macOS

    def _handle_editor_key(self, inp) -> None:
        """?????????? ??????? ? ?????? ?????????"""
        # ??????????? ??? ???????
        self._log_key(inp, f"[EDITOR FOCUS]")
        # TODO: ??????????? ????????? ?????? ?????????
        pass

    def _confirm_delete(self, terminal) -> bool:
        """
        ????????? ????????????? ???????? ?????

        Args:
            terminal: ?????? blessed.Terminal

        Returns:
            True ???? ????????????, False ?????
        """
        # ????????: ?????? ?????? True
        # TODO: ??????????? ?????? ?????????????
        return True

    def run(self) -> None:
        """?????? ??????????"""
        terminal = self.term_manager.get_terminal()

        try:
            # ???? ? ????????????? ?????
            print(self.term_manager.enter_fullscreen(), end="")
            print(self.term_manager.hide_cursor(), end="")

            self.running = True

            # ????????? ?????????
            self._render_with_status()

            # ???????? ???? ????????? ???????
            with terminal.cbreak(), terminal.hidden_cursor():
                while self.running:
                    # ???????? ????????? ???????? ?????????
                    if self.term_manager.has_size_changed():
                        # ???????? ??????? ? ????????????
                        self.refresh()
                        self._render_with_status()

                    # ????????????? ???????? ?????
                    inp = terminal.inkey(timeout=0.1)
                    
                    if inp:
                        # ??????????? ???? ?????? ??? ???????
                        self._log_key(inp, "[ALL KEYS]")
                        
                        # ?????
                        if inp.lower() == "q":
                            self.running = False
                            break
                        
                        # Tab - ???????????? ??????
                        if inp == '\t' or (hasattr(inp, 'name') and inp.name == 'TAB'):
                            logger.debug("Tab pressed - toggling focus")
                            self._toggle_focus()
                            self._render_with_status()
                            continue
                        
                        # ????????? ?????? ? ??????????? ?? ??????
                        if self.focused_pane == 'tree':
                            self._handle_tree_key(inp)
                            self._render_with_status()
                        elif self.focused_pane == 'editor':
                            self._handle_editor_key(inp)
                            self._render_with_status()

        except KeyboardInterrupt:
            self.running = False
        finally:
            # ????? ?? ?????????????? ?????? ? ?????????????? ???????
            print(self.term_manager.exit_fullscreen(), end="")
            print(self.term_manager.show_cursor(), end="")
            print(self.term_manager.clear(), end="")
            logger.info("Application closed")

    def refresh(self) -> None:
        """???????? ??????? ? ???????????? ?????"""
        self.term_manager.refresh_size()
        width, height = self.term_manager.get_size()
        self.layout.update_size(width, height)
        # ???????? ??????? ???????
        self.file_tree.x, self.file_tree.y, self.file_tree.width, self.file_tree.height = (
            self.layout.get_tree_bounds()
        )
        self.editor.x, self.editor.y, self.editor.width, self.editor.height = (
            self.layout.get_editor_bounds()
        )
